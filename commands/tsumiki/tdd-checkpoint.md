---
description: TDD開発の各フェーズ実行後に、完璧に実行されたか都度確認します。各コマンド実行後の品質チェックポイントを検証し、問題があれば修正提案を行います。
---

# TDD チェックポイント検証

TDD開発の各フェーズ実行後に、そのフェーズが完璧に実行されたかを確認します。

## 検証の目的

各TDDフェーズ（requirements/testcases/red/green/refactor）実行後に、そのフェーズの成果物が要求品質を満たしているかを検証し、次のフェーズに進む前に問題を早期発見します。

## 重要な原則

**⚠️ この工程では自動修正を行わない**
- この検証フェーズでは問題の検出と報告に専念する
- 問題を発見した場合は内容を詳細に報告する
- 修正が必要な場合はユーザーに明確に伝え、修正方針を提案する
- ユーザーの承認を得てから次のアクションを実行する

## 使用方法

各TDDコマンド実行後に以下のように実行してください：

```bash
# 要件定義後
/tsumiki:tdd-requirements
/tsumiki:tdd-checkpoint

# テストケース洗い出し後
/tsumiki:tdd-testcases
/tsumiki:tdd-checkpoint

# Redフェーズ後
/tsumiki:tdd-red
/tsumiki:tdd-checkpoint

# Greenフェーズ後
/tsumiki:tdd-green
/tsumiki:tdd-checkpoint

# Refactorフェーズ後
/tsumiki:tdd-refactor
/tsumiki:tdd-checkpoint
```

## 検証手順

### 1. 現在のフェーズ特定

以下の優先順位で現在のフェーズを自動判定：

1. **最新のmemoファイル確認**: 最終更新セクションから現在フェーズを特定
2. **ファイル存在確認**:
   - `{feature_name}-refactor-phase.md` → Refactorフェーズ
   - `{feature_name}-green-phase.md` → Greenフェーズ
   - `{feature_name}-red-phase.md` → Redフェーズ
   - `{feature_name}-testcases.md` → Testcasesフェーズ
   - `{feature_name}-requirements.md` → Requirementsフェーズ
3. **ユーザー確認**: 自動判定できない場合はユーザーに確認

### 2. 事前準備

検証コンテキストの準備を行います：

1. **追加ルールの読み込み**
   - `AGENTS.md` ファイルが存在する場合は読み込み
   - `docs/rule` ディレクトリが存在する場合は読み込み
   - `docs/rule/tdd` ディレクトリが存在する場合は読み込み
   - `docs/rule/tdd/checkpoint` ディレクトリが存在する場合は読み込み
   - 各ディレクトリ内のすべてのファイルを読み込み、追加ルールとして適用

2. **関連ファイルを直接読み込み**
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-memo.md` - 開発履歴を確認
   - 現在のフェーズに応じた成果物ファイル（requirements/testcases/red-phase/green-phase/refactor-phase.md）
   - 実装ファイルとテストファイル（該当する場合）
   - 元タスクファイル（`docs/tasks/{taskfile}.md`）

読み込み完了後、準備されたコンテキスト情報を基にチェックポイント検証を開始します。

### 3. フェーズ別検証

#### A. Requirements（要件定義）フェーズ

**検証ファイル**: `{feature_name}-requirements.md`

**検証項目**:

```markdown
## 📋 要件定義品質チェック

### ✅ 必須項目の完全性
- [ ] 機能の概要が明確に記載されている
- [ ] 入力・出力の仕様が具体的（型、範囲、制約）
- [ ] 制約条件が明確（パフォーマンス、セキュリティ、互換性）
- [ ] 想定される使用例が記載されている（基本パターン、エッジケース、エラーケース）
- [ ] EARS要件・設計文書との対応関係が明記されている

### 🎯 信頼性レベルの適切性
- [ ] 各項目に信頼性レベル（🔵🟡🔴）が記載されている
- [ ] 🔴（赤信号）が過度に多くない（全体の30%以下が望ましい）
- [ ] 重要な機能要件が🔴（推測）になっていない

### 📊 要件の明確性
- [ ] 曖昧な表現（「適切に」「うまく」等）が使われていない
- [ ] 数値的な基準が明確（処理時間、メモリ使用量等）
- [ ] エラーハンドリングの方針が明確

### 🔗 参照の完全性
- [ ] 参照した要件IDが具体的に記載されている
- [ ] 参照した設計文書のセクションが明記されている
- [ ] 技術スタック定義が確認されている

### 品質判定
- 全項目✅ → **合格** （次フェーズへ進行可能）
- 1-2項目❌ → **要改善** （軽微な修正後に進行）
- 3項目以上❌ → **不合格** （要件定義の再実行が必要）
```

#### B. Testcases（テストケース）フェーズ

**検証ファイル**: `{feature_name}-testcases.md`

**検証項目**:

```markdown
## 📋 テストケース品質チェック

### ✅ テストケース分類の網羅性
- [ ] 正常系テストケースが定義されている（最低3件）
- [ ] 異常系テストケースが定義されている（最低2件）
- [ ] 境界値テストケースが定義されている（最低2件）
- [ ] 各テストケースに期待値が明確に記載されている

### 🎯 テストケースの具体性
- [ ] 入力値が具体的な値で記載されている
- [ ] 期待される結果が具体的に記載されている
- [ ] テストの目的が明確に説明されている
- [ ] 各テストケースに信頼性レベル（🔵🟡🔴）が記載されている

### 🛠️ 技術選択の明確性
- [ ] プログラミング言語が明記されている
- [ ] テストフレームワークが明記されている
- [ ] 技術選択の理由が説明されている

### 📝 コメント指針の明確性
- [ ] テストケース開始時のコメント形式が定義されている
- [ ] Given/When/Then各フェーズのコメント形式が定義されている
- [ ] expectステートメントのコメント形式が定義されている

### 🔗 要件との対応
- [ ] 要件定義書の全項目がテストケースでカバーされている
- [ ] テストケースと要件項目の対応関係が明確

### 品質判定
- 全項目✅ → **合格** （次フェーズへ進行可能）
- 1-2項目❌ → **要改善** （テストケースの追加・修正後に進行）
- 3項目以上❌ → **不合格** （テストケース洗い出しの再実行が必要）
```

#### C. Red（失敗テスト作成）フェーズ

**検証ファイル**: `{feature_name}-red-phase.md`、テストファイル

**検証項目**:

```markdown
## 📋 Redフェーズ品質チェック

### ✅ テストコードの実装状況
- [ ] 10件以上のテストケースが実装されている（または全テストケース）
- [ ] テストファイルが存在し、実行可能な状態である
- [ ] すべてのテストが失敗する状態である（未実装のため）

### 🎯 テストコードの品質
- [ ] Given-When-Then構造が明確である
- [ ] 各テストに日本語コメントが充実している
- [ ] テスト目的・内容・期待動作がコメントに記載されている
- [ ] 信頼性レベル（🔵🟡🔴）がコメントに記載されている

### 📝 コメントの充実度
- [ ] 【テスト目的】コメントが記載されている
- [ ] 【テスト内容】コメントが記載されている
- [ ] 【期待される動作】コメントが記載されている
- [ ] 【テストデータ準備】コメントが記載されている
- [ ] 【実際の処理実行】コメントが記載されている
- [ ] 【結果検証】コメントが記載されている
- [ ] 各expectに【確認内容】コメントが記載されている

### 🧪 テスト実行確認（Taskツールで実行）
- [ ] テストコマンドが実行できる
- [ ] 期待通りの失敗メッセージが出力される
- [ ] テストフレームワークが正しく動作している

### 🔗 テストケース定義との対応
- [ ] testcases.mdで定義したテストケースが実装されている
- [ ] 未実装のテストケースがリスト化されている

### 📄 ドキュメント更新
- [ ] red-phase.mdに実装内容が記載されている
- [ ] memoファイルのRedフェーズセクションが更新されている
- [ ] 期待される失敗メッセージが記載されている

### 品質判定
- 全項目✅ → **合格** （次フェーズへ進行可能）
- 1-3項目❌ → **要改善** （軽微な修正後に進行）
- 4項目以上❌ → **不合格** （Redフェーズの再実行が必要）
```

#### D. Green（実装）フェーズ

**検証ファイル**: `{feature_name}-green-phase.md`、実装ファイル、テストファイル

**検証項目**:

```markdown
## 📋 Greenフェーズ品質チェック

### ✅ テスト成功状況（Taskツールで実行）
- [ ] Redフェーズで作成した全テストが成功している
- [ ] 既存の全テストが引き続き成功している
- [ ] テストカバレッジが要求水準を満たしている

### 🎯 実装コードの品質
- [ ] 実装ファイルが存在し、必要な機能が実装されている
- [ ] 各関数・メソッドに日本語コメントが充実している
- [ ] 信頼性レベル（🔵🟡🔴）がコメントに記載されている

### 📝 コメントの充実度
- [ ] 【機能概要】コメントが記載されている
- [ ] 【実装方針】コメントが記載されている
- [ ] 【テスト対応】コメントが記載されている
- [ ] 【入力値検証】コメントが記載されている（該当する場合）
- [ ] 【エラー処理】コメントが記載されている（該当する場合）

### 🚫 禁止事項の遵守
- [ ] テストのスキップがない（.skip使用なし）
- [ ] 必要なテストの削除がない
- [ ] 実装コード内でのモック・スタブ記述がない
- [ ] 実装コード内でDBに代わるインメモリーストレージを使用していない
- [ ] DB操作を省略していない

### 📏 ファイルサイズ
- [ ] 実装ファイルが800行以下である
- [ ] 800行を超える場合は分割計画が記載されている

### 📄 ドキュメント更新
- [ ] green-phase.mdに実装内容が記載されている
- [ ] memoファイルのGreenフェーズセクションが更新されている
- [ ] テスト結果が記載されている
- [ ] 次のRefactorフェーズでの改善点が記載されている

### 品質判定
- 全項目✅ → **合格** （次フェーズへ進行可能）
- 1-3項目❌ → **要改善** （修正後に進行）
- 4項目以上❌ → **不合格** （Greenフェーズの再実行が必要）
```

#### E. Refactor（リファクタリング）フェーズ

**検証ファイル**: `{feature_name}-refactor-phase.md`、実装ファイル、テストファイル

**検証項目**:

```markdown
## 📋 Refactorフェーズ品質チェック

### ✅ テスト継続成功（Taskツールで実行）
- [ ] リファクタリング後も全テストが成功している
- [ ] テストカバレッジが維持または向上している
- [ ] 新規テストが必要に応じて追加されている

### 🎯 コード品質の改善
- [ ] 変数名・関数名が分かりやすく改善されている
- [ ] 重複コードが除去されている（DRY原則）
- [ ] コードの構造が分かりやすく整理されている
- [ ] 単一責任原則が適用されている

### 📏 ファイルサイズの最適化
- [ ] 実装ファイルが500行以下である
- [ ] 長大なファイルが機能別に分割されている
- [ ] 適切なモジュール境界が設定されている

### 🔧 コード品質ツール確認（Taskツールで実行）
- [ ] lintエラーが解消されている
- [ ] typecheckエラーが解消されている
- [ ] フォーマットが統一されている

### 🛡️ セキュリティレビュー
- [ ] 入力値検証が適切に実装されている
- [ ] SQLインジェクション対策が確認されている（該当する場合）
- [ ] XSS対策が確認されている（該当する場合）
- [ ] 認証・認可が適切に実装されている（該当する場合）

### ⚡ パフォーマンスレビュー
- [ ] アルゴリズムの計算量が適切である
- [ ] 不要な処理が削除されている
- [ ] データベースクエリが最適化されている（該当する場合）
- [ ] 非同期処理が適切に実装されている（該当する場合）

### 🚫 禁止事項の遵守
- [ ] 実装コード内でのモック・スタブ記述がない
- [ ] 実装コード内でDBに代わるインメモリーストレージを使用していない

### 📄 ドキュメント更新
- [ ] refactor-phase.mdに改善内容が記載されている
- [ ] memoファイルのRefactorフェーズセクションが更新されている
- [ ] セキュリティレビュー結果が記載されている
- [ ] パフォーマンスレビュー結果が記載されている
- [ ] 最終的な品質評価が記載されている

### 品質判定
- 全項目✅ → **合格** （verify-completeフェーズへ進行可能）
- 1-3項目❌ → **要改善** （修正後に進行）
- 4項目以上❌ → **不合格** （Refactorフェーズの再実行が必要）
```

## 検証結果の出力形式

### 合格の場合

```
✅ **チェックポイント検証: 合格**

📊 [{フェーズ名}]フェーズ品質評価:
- 検証項目総数: {総数}項目
- 合格項目: {合格数}項目
- 品質スコア: 100%

🎯 確認された成果物:
- {成果物1}: 品質基準を満たしています
- {成果物2}: 品質基準を満たしています

✨ 次のお勧めステップ:
`{次のコマンド}` で次のフェーズを開始します。
```

### 要改善の場合

```
⚠️ **チェックポイント検証: 要改善**

📊 [{フェーズ名}]フェーズ品質評価:
- 検証項目総数: {総数}項目
- 合格項目: {合格数}項目
- 要改善項目: {改善数}項目
- 品質スコア: {スコア}%

❌ 改善が必要な項目:
1. **{改善項目1}**
   - **問題**: {具体的な問題内容}
   - **影響**: {この問題が及ぼす影響}
   - **修正方針**: {推奨される修正方法}

2. **{改善項目2}**
   - **問題**: {具体的な問題内容}
   - **影響**: {この問題が及ぼす影響}
   - **修正方針**: {推奨される修正方法}

🔧 推奨アクション:
これらの項目を修正してから次のフェーズに進むことを推奨します。
修正後、再度 `/tsumiki:tdd-checkpoint` で検証してください。
```

### 不合格の場合

```
❌ **チェックポイント検証: 不合格**

📊 [{フェーズ名}]フェーズ品質評価:
- 検証項目総数: {総数}項目
- 合格項目: {合格数}項目
- 不合格項目: {不合格数}項目
- 品質スコア: {スコア}%

🚨 重大な問題:
1. **{不合格項目1}**
   - **問題**: {具体的な問題内容}
   - **影響**: {この問題が及ぼす重大な影響}
   - **必須対応**: {必須の修正内容}

2. **{不合格項目2}**
   - **問題**: {具体的な問題内容}
   - **影響**: {この問題が及ぼす重大な影響}
   - **必須対応**: {必須の修正内容}

⛔ 必須アクション:
品質基準を満たしていないため、次のフェーズに進むことはできません。
`{現在のコマンド}` を再実行し、上記の問題を解決してください。
```

## 自動遷移判定

### 品質スコアによる判定

```
✅ 合格 (100%):
- 全検証項目が基準を満たしている
- 次のフェーズへの進行を推奨

⚠️ 要改善 (80-99%):
- 大部分の項目は基準を満たしている
- 軽微な改善後、次のフェーズへの進行可能
- ユーザー判断で進行するかどうか決定

❌ 不合格 (<80%):
- 重要な項目が基準を満たしていない
- 現在のフェーズを再実行する必要がある
- 次のフェーズへの進行は非推奨
```

## 検証記録

検証結果は以下に自動記録されます：

1. **memoファイル**: 各フェーズセクションに「チェックポイント検証結果」を追記
2. **checkpoint-log.md**: 全チェックポイント検証の履歴を記録（新規作成）

```markdown
# チェックポイント検証履歴

## [{日時}] {フェーズ名}フェーズ検証

### 検証結果: {合格/要改善/不合格}

### 品質スコア: {スコア}%

### 詳細:
- 合格項目: {リスト}
- 改善項目: {リスト}
- 不合格項目: {リスト}

### アクション:
- {実施したアクション}
```

## 使用例

```bash
# 1. 要件定義実行
/tsumiki:tdd-requirements feature_name="ユーザー認証"

# 2. チェックポイント検証
/tsumiki:tdd-checkpoint
# → Requirementsフェーズを自動検出
# → 要件定義の品質を検証
# → 結果を報告

# 3. 問題があれば修正後に再検証
/tsumiki:tdd-checkpoint
# → 再度検証して合格を確認

# 4. 次のフェーズへ進行
/tsumiki:tdd-testcases
```

この検証により、各TDDフェーズの品質と完全性を確保し、スムーズな開発進行を実現します。
