name: Check Tsumiki Updates

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 10:00 JST (01:00 UTC)
    - cron: '0 1 * * 1'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Get last check timestamp
        id: last_check
        run: |
          # å‰å›ãƒã‚§ãƒƒã‚¯æ™‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯7æ—¥å‰ï¼‰
          if [ -f .github/.last-tsumiki-check ]; then
            LAST_CHECK=$(cat .github/.last-tsumiki-check)
          else
            LAST_CHECK=$(date -d '7 days ago' --iso-8601=seconds)
          fi
          echo "timestamp=$LAST_CHECK" >> $GITHUB_OUTPUT

      - name: Clone Tsumiki
        run: |
          git clone https://github.com/classmethod/tsumiki.git /tmp/tsumiki

      - name: Check for updates
        id: check_updates
        run: |
          cd /tmp/tsumiki
          LAST_CHECK="${{ steps.last_check.outputs.timestamp }}"

          # å‰å›ãƒã‚§ãƒƒã‚¯ä»¥é™ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
          COMMITS=$(git log --since="$LAST_CHECK" --pretty=format:"%H" | wc -l)

          if [ "$COMMITS" -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
            CHANGED_FILES=$(git log --since="$LAST_CHECK" --name-only --pretty=format: | sort -u | grep -v '^$')
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
            COMMIT_INFO=$(git log --since="$LAST_CHECK" --pretty=format:"- [%h](https://github.com/classmethod/tsumiki/commit/%H) %s (%ar)" --reverse)
            echo "commit_info<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMIT_INFO" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®ãƒãƒƒã‚·ãƒ¥
            LATEST_COMMIT=$(git log -1 --pretty=format:"%H")
            echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue
        if: steps.check_updates.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = `${{ steps.check_updates.outputs.changed_files }}`;
            const commitInfo = `${{ steps.check_updates.outputs.commit_info }}`;
            const latestCommit = `${{ steps.check_updates.outputs.latest_commit }}`;

            // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒªã‚¹ãƒˆã«æ•´å½¢
            const fileList = changedFiles.split('\n')
              .filter(f => f.trim())
              .map(f => `- \`${f}\``)
              .join('\n');

            const issueBody = `## ğŸ“¢ Tsumiki Update Detected

            [classmethod/tsumiki](https://github.com/classmethod/tsumiki) ã«æ–°ã—ã„æ›´æ–°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚

            ## ğŸ“ Changed Files

            ${fileList}

            ## ğŸ“ Commits

            ${commitInfo}

            ## ğŸ”— Links

            - [Latest Commit](https://github.com/classmethod/tsumiki/commit/${latestCommit})
            - [Compare Changes](https://github.com/classmethod/tsumiki/compare/main...${latestCommit})
            - [Repository](https://github.com/classmethod/tsumiki)

            ## âœ… Action Items

            - [ ] å¤‰æ›´å†…å®¹ã‚’ç¢ºèª
            - [ ] TDDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¸ã®å½±éŸ¿ã‚’ç¢ºèª
            - [ ] ã‚³ãƒãƒ³ãƒ‰å®šç¾©ã®æ›´æ–°ãŒå¿…è¦ã‹æ¤œè¨
            - [ ] ç ´å£Šçš„å¤‰æ›´ãŒãªã„ã‹ç¢ºèª

            ---

            ğŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸIssueã§ã™ï¼ˆé€±æ¬¡ãƒã‚§ãƒƒã‚¯: æ¯é€±æœˆæ›œæ—¥ 10:00 JSTï¼‰`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ Tsumiki Update - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['upstream-update', 'tsumiki', 'automated']
            });

      - name: Update last check timestamp
        if: always()
        run: |
          mkdir -p .github
          date --iso-8601=seconds > .github/.last-tsumiki-check
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/.last-tsumiki-check
          git diff --staged --quiet || git commit -m "chore: Update Tsumiki check timestamp [skip ci]"
          git push
